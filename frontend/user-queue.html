<!DOCTYPE html>
<html lang="en">
	<head>
		<meta charset="UTF-8" />
		<meta name="viewport" content="width=device-width, initial-scale=1.0" />
		<title>User Queue | QueueEase</title>

		<!-- Google Font: Poppins -->
		<link
			href="https://fonts.googleapis.com/css2?family=Poppins:wght@400;600&display=swap"
			rel="stylesheet"
		/>

		<!-- Bootstrap CSS -->
		<link
			href="https://cdn.jsdelivr.net/npm/bootstrap@5.3.0-alpha1/dist/css/bootstrap.min.css"
			rel="stylesheet"
		/>

		<!-- Font Awesome for logout icon -->
		<link
			href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.0.0-beta3/css/all.min.css"
			rel="stylesheet"
		/>

		<!-- Custom Stylesheet -->
		<link rel="stylesheet" href="css/user-queue.css" />

		<!-- JavaScript for dynamic functionality -->
		<script src="/socket.io/socket.io.js"></script>
		<script>
			const socket = io();

			// Get user ID from localStorage
			function getUserID() {
				const user_id = localStorage.getItem("id");
				if (!user_id) {
					alert("Failed to retrieve user ID. Please log in again.");
					window.location.href = "login.html";
					return null;
				}
				return user_id;
			}

			// Update queue status dynamically
			async function updateQueueStatus() {
				const user_id = getUserID();
				if (!user_id) return;

				try {
					const response = await fetch(`/api/users/queue-status/${user_id}`);
					if (!response.ok) throw new Error("Failed to fetch queue status.");

					const data = await response.json();
					const queueStats = document.getElementById("queueStats");
					const { currently_serving, user_queue } = data;

					queueStats.innerHTML = `
          <p><strong>Currently Serving:</strong> ${
						currently_serving.queue_number !== "None"
							? `Queue #${currently_serving.queue_number} (${currently_serving.service_name})`
							: "None"
					}</p>
          <p><strong>Your Queue Number:</strong> ${
						user_queue.queue_number !== "Not in queue"
							? `Queue #${user_queue.queue_number} (${user_queue.service_name})`
							: "Not in queue"
					}</p>
        `;
				} catch (error) {
					console.error("Error fetching queue status:", error);
					document.getElementById("queueStats").innerHTML =
						"<p>Failed to load queue status.</p>";
				}
			}

			// Function to join the queue
			async function joinQueue() {
				const serviceSelect = document.getElementById("service_id");
				const service_id = serviceSelect.value;

				if (!service_id) {
					alert("Please select a transaction.");
					return;
				}

				const user_id = getUserID();
				if (!user_id) return;

				const data = { user_id, service_id };

				try {
					const response = await fetch("/api/users/transactions", {
						method: "POST",
						headers: { "Content-Type": "application/json" },
						body: JSON.stringify(data),
					});

					const result = await response.json();

					if (response.ok) {
						alert("You have successfully joined the queue.");
						socket.emit("queueUpdated");
					} else {
						alert(result.error || "Failed to join the queue.");
					}
				} catch (error) {
					console.error("Error joining queue:", error);
					alert("An unexpected error occurred.");
				}
			}

			// Load available services for the dropdown
			async function loadServices() {
				try {
					const response = await fetch("/api/users/services");
					if (!response.ok) throw new Error("Failed to fetch services.");

					const services = await response.json();
					const serviceSelect = document.getElementById("service_id");

					services.forEach((service) => {
						const option = document.createElement("option");
						option.value = service.service_id;
						option.textContent = service.service_name;
						serviceSelect.appendChild(option);
					});
				} catch (error) {
					console.error("Error fetching services:", error);
					alert("Failed to load services.");
				}
			}

			// Initialize page and real-time updates
			document.addEventListener("DOMContentLoaded", () => {
				loadServices();

				const joinQueueButton = document.getElementById("joinQueueButton");
				joinQueueButton.addEventListener("click", joinQueue);

				setInterval(updateQueueStatus, 1000);

				socket.on("queueUpdated", updateQueueStatus);
			});
		</script>
	</head>
	<body>
		<header>
			<div class="navbar">
				<a href="user-dashboard.html">
					<i class="fas fa-arrow-left"></i> Go back to Dashboard
				</a>
				<span class="queueease">|| QueueEase</span>
			</div>
		</header>

		<!-- Main Content -->
		<main class="content-container container mt-4">
			<!-- Queue Status Section -->
			<section id="queueStats" class="queue-section">
				<h2>Queue Status</h2>
				<div class="queue-status">
					<p>Loading queue status...</p>
				</div>
			</section>

			<!-- Join Queue Section -->
			<section class="queue-section mt-4">
				<h2>Join Queue</h2>
				<label for="service_id" class="form-label">Membership Program:</label>
				<select id="service_id" name="service_id" class="form-select" required>
					<option value="" disabled selected>Select a service</option>
				</select>
				<button id="joinQueueButton" class="btn btn-custom mt-3">
					Join Queue
				</button>
			</section>

			<section class="queue-section mt-4">
				<h2>Membership Information</h2>
				<div>
					<h3>Informal Economy</h3>
					<div>
						<h4>Migrant Workers</h4>
						<p>
							- documented or undocumented Filipinos who are engaged in a
							remunerated activity in another country of which they are not
							citizens
						</p>
						<h4>Informal Sector</h4>
						<p>
							- includes among others, street hawkers, market vendors, pedicab
							and tricycle drivers, small construction workers, and home-based
							industries and services.
						</p>
						<h4>Self-Employed Individuals</h4>
						<p>
							- individuals who render services or sell goods as a means of
							livelihood outside of an employer-employee relationship or as a
							career. These include professional practitioners including but not
							limited to doctors, lawyers, engineers, artists, architects and
							the like, businessmen, entrepreneurs, actors, actresses and other
							performers, news correspondents, professional athletes, coaches,
							trainers, and such other individuals.
						</p>
						<h4>Filipinos With Dual Citizenship</h4>
						<p>- Filipinos who are also citizens of other countries.</p>
						<h4>Naturalized Filipino Citizen</h4>
						<p>
							- those who have become Filipino citizens through naturalization
							as governed by Commonwealth Act No. 473 or the Revised
							Naturalization Law.
						</p>
						<h4>
							Citizens of Other Countries Working and/or Residing in the
							Philippines
						</h4>
						<p>
							- foreign citizens with valid working permits and/or Alien
							Certificate of Registrations (ACRs), working and/or residing in
							the Philippines.
						</p>
					</div>
				</div>
			</section>
		</main>

		<!-- Footer -->
		<footer
			class="text-center text-light py-3"
			style="background-color: #12372a"
		>
			Â©2024 QueueEase. All rights reserved.
		</footer>

		<!-- Bootstrap JS -->
		<script src="https://cdn.jsdelivr.net/npm/bootstrap@5.3.0-alpha1/dist/js/bootstrap.bundle.min.js"></script>
	</body>
</html>